#!/bin/sh

# 자동 커밋 메시지인지 확인 (무한루프 방지)
commit_message=$(git log -1 --pretty=%B)
if [[ "$commit_message" == *"[AUTO] 프론트매터 업데이트"* ]]; then
  echo "🚫 자동 커밋이므로 프론트매터 업데이트를 건너뜁니다."
  exit 0
fi

# 마지막 커밋에서 변경된 마크다운 파일 찾기
changed_md_files=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(md|markdown)$' || true)

# 마크다운 파일이 변경된 경우에만 프론트매터 업데이트
if [ -n "$changed_md_files" ]; then
  echo "🔄 커밋 완료 후 프론트매터를 업데이트합니다..."
  
  # 변경된 마크다운 파일들의 프론트매터 업데이트
  for file in $changed_md_files; do
    if [ -f "$file" ]; then
      echo "  📝 $file"
      node scripts/clean-frontmatter.js "$file"
    fi
  done
  
  # 변경사항이 있는지 확인
  if ! git diff --quiet; then
    echo "✅ 프론트매터가 업데이트되어 추가 커밋을 생성합니다..."
    git add .
    git commit -m "[AUTO] 프론트매터 업데이트 - 커밋 이력 동기화"
  else
    echo "📝 프론트매터에 변경사항이 없습니다."
  fi
else
  echo "📝 변경된 마크다운 파일이 없어 프론트매터 업데이트를 건너뜁니다."
fi
