#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MSG_FILE="$1"

echo "🚀 Running commit-msg hook..."
echo "📝 Commit message file: $COMMIT_MSG_FILE"

# Run the script to update frontmatter.
# The script will read the message from COMMIT_MSG_FILE and 'git add' the modified files.
if pnpm exec node scripts/update-frontmatter.js "$COMMIT_MSG_FILE"; then
  echo "✅ Frontmatter update script completed."

  # Check if there are any staged changes made by the script.
  # `git diff --cached --quiet` exits with 0 if no changes, 1 if changes.
  if ! git diff --cached --quiet; then
    echo "📝 Found staged changes from frontmatter update. Amending commit..."
    # Amend the commit to include these changes.
    # --no-verify: skip hooks for this amend operation to prevent loops.
    git commit --amend --no-verify -m "$(cat "$COMMIT_MSG_FILE")"
    if [ $? -eq 0 ]; then
      echo "✅ Commit successfully amended with frontmatter updates."
    else
      echo "❌ Failed to amend commit."
      exit 1
    fi
  else
    echo "ℹ️ No frontmatter changes were staged by the script. Nothing to amend."
  fi
else
  echo "❌ Frontmatter update script failed."
  exit 1 # Propagate error from the script
fi

echo "🎉 commit-msg hook finished."
exit 0
